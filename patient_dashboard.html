<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Valley Transit - Patient Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #f3f4f6; font-family: 'Inter', sans-serif; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .gradient-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; font-weight: 600; border-radius: 10px; padding: 0.75rem 1.5rem;
            border: none; cursor: pointer; transition: all 0.3s ease;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .status-scheduled { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #dcfce7; color: #166534; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <header class="gradient-header text-white py-4 px-6 shadow-lg">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">üè•</span>
                <div>
                    <h1 class="text-xl font-bold">Golden Valley Transit</h1>
                    <p class="text-sm text-blue-100">Patient Portal</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span id="welcomeName" class="text-sm">Welcome</span>
                <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-sm font-semibold transition">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-6">
        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <a href="https://www.goldenvalleytransit.com/#contact" class="card p-6 hover:shadow-lg transition cursor-pointer">
                <div class="text-3xl mb-3">üìÖ</div>
                <h3 class="font-bold text-gray-800 mb-1">Book New Ride</h3>
                <p class="text-gray-500 text-sm">Schedule your next medical transportation</p>
            </a>
            <div class="card p-6">
                <div class="text-3xl mb-3">üìû</div>
                <h3 class="font-bold text-gray-800 mb-1">Contact Us</h3>
                <p class="text-gray-500 text-sm"><a href="tel:6615550123" class="text-purple-600">(661) 555-0123</a></p>
            </div>
            <div class="card p-6">
                <div class="text-3xl mb-3">‚è∞</div>
                <h3 class="font-bold text-gray-800 mb-1">Hours</h3>
                <p class="text-gray-500 text-sm">6:00 AM - 10:00 PM Daily</p>
            </div>
        </div>

        <!-- Upcoming Trips -->
        <div class="card p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Upcoming Trips</h2>
                <button onclick="refreshTrips()" class="text-purple-600 hover:text-purple-800 text-sm font-semibold">
                    Refresh
                </button>
            </div>
            <div id="upcomingTrips" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üîÑ</div>
                    <p>Loading trips...</p>
                </div>
            </div>
        </div>

        <!-- Trip History -->
        <div class="card p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">Trip History</h2>
            <div id="tripHistory" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üîÑ</div>
                    <p>Loading history...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Check authentication
        const patientId = sessionStorage.getItem('patientId');
        const patientName = sessionStorage.getItem('patientName');
        
        if (!patientId) {
            window.location.href = '/patient-portal';
        } else {
            document.getElementById('welcomeName').textContent = `Welcome, ${patientName || 'Patient'}`;
            loadTrips();
        }
        
        async function loadTrips() {
            try {
                const response = await fetch(`/api/patient/${patientId}/trips`);
                const data = await response.json();
                
                if (data.success) {
                    renderUpcomingTrips(data.upcoming || []);
                    renderTripHistory(data.history || []);
                }
            } catch (error) {
                console.error('Error loading trips:', error);
                document.getElementById('upcomingTrips').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p>Unable to load trips. Please try again.</p>
                    </div>`;
            }
        }
        
        function renderUpcomingTrips(trips) {
            const container = document.getElementById('upcomingTrips');
            
            if (trips.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üìÖ</div>
                        <p>No upcoming trips scheduled</p>
                        <a href="https://www.goldenvalleytransit.com/#contact" class="btn-primary inline-block mt-4">Book a Ride</a>
                    </div>`;
                return;
            }
            
            container.innerHTML = trips.map(trip => `
                <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold status-scheduled">
                                    ${trip.status || 'Scheduled'}
                                </span>
                                <span class="text-gray-500 text-sm">${trip.trip_number}</span>
                            </div>
                            <p class="font-semibold text-gray-800">${formatDate(trip.scheduled_pickup_time)}</p>
                            <p class="text-gray-600 text-sm mt-1">üìç ${trip.pickup_address}</p>
                            <p class="text-gray-600 text-sm">üè• ${trip.destination_address}</p>
                        </div>
                        <div class="text-right">
                            ${trip.driver_name ? `<p class="text-sm text-gray-600">Driver: ${trip.driver_name}</p>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderTripHistory(trips) {
            const container = document.getElementById('tripHistory');
            
            if (trips.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üìã</div>
                        <p>No trip history yet</p>
                    </div>`;
                return;
            }
            
            container.innerHTML = trips.map(trip => `
                <div class="border border-gray-200 rounded-xl p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold status-${trip.status?.toLowerCase() || 'completed'}">
                                    ${trip.status || 'Completed'}
                                </span>
                                <span class="text-gray-500 text-sm">${trip.trip_number}</span>
                            </div>
                            <p class="font-semibold text-gray-800">${formatDate(trip.scheduled_pickup_time)}</p>
                            <p class="text-gray-600 text-sm mt-1">üìç ${trip.pickup_address}</p>
                            <p class="text-gray-600 text-sm">üè• ${trip.destination_address}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Date TBD';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', month: 'short', day: 'numeric', 
                hour: 'numeric', minute: '2-digit' 
            });
        }
        
        function refreshTrips() {
            loadTrips();
        }
        
        function logout() {
            sessionStorage.clear();
            window.location.href = '/patient-portal';
        }
    </script>
</body>
</html>
