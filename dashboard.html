<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Valley Transit - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        .header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #666; font-size: 1.1em; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .stat-card .number { font-size: 3em; font-weight: bold; color: #667eea; }
        .stat-card.patients .number { color: #667eea; }
        .stat-card.drivers .number { color: #f093fb; }
        .stat-card.vehicles .number { color: #4facfe; }
        .stat-card.trips .number { color: #43e97b; }
        .stat-card.claims .number { color: #fa709a; }
        
        .tabs { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .tab-buttons { display: flex; background: #f8f9fa; border-bottom: 2px solid #e9ecef; overflow-x: auto; }
        .tab-button {
            flex: 1;
            min-width: 140px;
            padding: 20px;
            background: none;
            border: none;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab-button:hover { background: #e9ecef; }
        .tab-button.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-refresh { background: #43e97b; color: white; }
        .btn-refresh:hover { background: #38d06a; }
        .btn-approve { background: #55efc4; color: #00b894; padding: 8px 15px; font-size: 0.9em; }
        .btn-deny { background: #fab1a0; color: #d63031; padding: 8px 15px; font-size: 0.9em; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef; }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            font-size: 0.85em;
        }
        tr:hover { background: #f8f9fa; }
        
        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-scheduled { background: #ffeaa7; color: #fdcb6e; }
        .badge-completed { background: #55efc4; color: #00b894; }
        .badge-cancelled { background: #fab1a0; color: #d63031; }
        .badge-submitted { background: #74b9ff; color: #0984e3; }
        .badge-approved { background: #55efc4; color: #00b894; }
        .badge-denied { background: #fab1a0; color: #d63031; }
        
        .form-container {
            display: none;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .form-container.active { display: block; }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label {
            margin-bottom: 5px;
            color: #666;
            font-weight: 600;
            font-size: 0.9em;
        }
        .form-group input, .form-group select, .form-group textarea {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        
        .loading { text-align: center; padding: 40px; color: #666; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .tab-button { font-size: 0.9em; padding: 15px 10px; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöê Golden Valley Transit</h1>
            <p>Medical Transportation Management Dashboard</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card patients">
                <h3>Patients</h3>
                <div class="number" id="totalPatients">-</div>
            </div>
            <div class="stat-card drivers">
                <h3>Drivers</h3>
                <div class="number" id="totalDrivers">-</div>
            </div>
            <div class="stat-card vehicles">
                <h3>Vehicles</h3>
                <div class="number" id="totalVehicles">-</div>
            </div>
            <div class="stat-card trips">
                <h3>Active Trips</h3>
                <div class="number" id="activeTrips">-</div>
            </div>
            <div class="stat-card claims">
                <h3>Pending Claims</h3>
                <div class="number" id="pendingClaims">-</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('patients')">üë• Patients</button>
                <button class="tab-button" onclick="switchTab('drivers')">üöó Drivers</button>
                <button class="tab-button" onclick="switchTab('vehicles')">üöê Vehicles</button>
                <button class="tab-button" onclick="switchTab('trips')">üìÖ Trips</button>
                <button class="tab-button" onclick="switchTab('claims')">üí∞ Claims</button>
            </div>

            <div id="patients" class="tab-content active">
                <div class="action-bar">
                    <h2>Patients</h2>
                    <div>
                        <button class="btn btn-refresh" onclick="loadPatients()">üîÑ</button>
                        <button class="btn btn-primary" onclick="toggleForm('patientForm')">‚ûï Add Patient</button>
                    </div>
                </div>
                <div id="patientForm" class="form-container">
                    <h3>Add New Patient</h3>
                    <form onsubmit="createPatient(event)">
                        <div class="form-grid">
                            <div class="form-group"><label>First Name *</label><input type="text" id="patientFirstName" required></div>
                            <div class="form-group"><label>Last Name *</label><input type="text" id="patientLastName" required></div>
                            <div class="form-group"><label>Phone</label><input type="tel" id="patientPhone"></div>
                            <div class="form-group"><label>Email</label><input type="email" id="patientEmail"></div>
                            <div class="form-group"><label>Address</label><input type="text" id="patientAddress"></div>
                            <div class="form-group"><label>Date of Birth</label><input type="date" id="patientDOB"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn" onclick="toggleForm('patientForm')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div id="patientsTable"></div>
            </div>

            <div id="drivers" class="tab-content">
                <div class="action-bar">
                    <h2>Drivers</h2>
                    <div>
                        <button class="btn btn-refresh" onclick="loadDrivers()">üîÑ</button>
                        <button class="btn btn-primary" onclick="toggleForm('driverForm')">‚ûï Add Driver</button>
                    </div>
                </div>
                <div id="driverForm" class="form-container">
                    <h3>Add New Driver</h3>
                    <form onsubmit="createDriver(event)">
                        <div class="form-grid">
                            <div class="form-group"><label>First Name *</label><input type="text" id="driverFirstName" required></div>
                            <div class="form-group"><label>Last Name *</label><input type="text" id="driverLastName" required></div>
                            <div class="form-group"><label>Phone *</label><input type="tel" id="driverPhone" required></div>
                            <div class="form-group"><label>Email</label><input type="email" id="driverEmail"></div>
                            <div class="form-group"><label>Address</label><input type="text" id="driverAddress"></div>
                            <div class="form-group"><label>License #</label><input type="text" id="driverLicense"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn" onclick="toggleForm('driverForm')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div id="driversTable"></div>
            </div>

            <div id="vehicles" class="tab-content">
                <div class="action-bar">
                    <h2>Vehicles</h2>
                    <div>
                        <button class="btn btn-refresh" onclick="loadVehicles()">üîÑ</button>
                        <button class="btn btn-primary" onclick="toggleForm('vehicleForm')">‚ûï Add Vehicle</button>
                    </div>
                </div>
                <div id="vehicleForm" class="form-container">
                    <h3>Add New Vehicle</h3>
                    <form onsubmit="createVehicle(event)">
                        <div class="form-grid">
                            <div class="form-group"><label>Vehicle ID *</label><input type="text" id="vehicleId" required></div>
                            <div class="form-group"><label>Make *</label><input type="text" id="vehicleMake" required></div>
                            <div class="form-group"><label>Model *</label><input type="text" id="vehicleModel" required></div>
                            <div class="form-group"><label>Year *</label><input type="number" id="vehicleYear" required min="2000" max="2030"></div>
                            <div class="form-group"><label>License Plate</label><input type="text" id="vehiclePlate"></div>
                            <div class="form-group"><label>VIN</label><input type="text" id="vehicleVin"></div>
                            <div class="form-group"><label>Capacity</label><input type="text" id="vehicleCapacity"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn" onclick="toggleForm('vehicleForm')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div id="vehiclesTable"></div>
            </div>

            <div id="trips" class="tab-content">
                <div class="action-bar">
                    <h2>Trips</h2>
                    <div>
                        <button class="btn btn-refresh" onclick="loadTrips()">üîÑ</button>
                        <button class="btn btn-primary" onclick="toggleForm('tripForm')">‚ûï Schedule Trip</button>
                    </div>
                </div>
                <div id="tripForm" class="form-container">
                    <h3>Schedule New Trip</h3>
                    <form onsubmit="createTrip(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Trip Type *</label>
                                <select id="tripType" required>
                                    <option value="">Select</option>
                                    <option value="Dialysis">Dialysis</option>
                                    <option value="Physical Therapy">Physical Therapy</option>
                                    <option value="Doctor Appointment">Doctor Appointment</option>
                                    <option value="Hospital Visit">Hospital Visit</option>
                                </select>
                            </div>
                            <div class="form-group"><label>Pickup Address *</label><input type="text" id="tripPickupAddress" required></div>
                            <div class="form-group"><label>Pickup Time *</label><input type="datetime-local" id="tripPickupTime" required></div>
                            <div class="form-group"><label>Dropoff Address *</label><input type="text" id="tripDropoffAddress" required></div>
                            <div class="form-group"><label>Dropoff Time</label><input type="datetime-local" id="tripDropoffTime"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Schedule</button>
                            <button type="button" class="btn" onclick="toggleForm('tripForm')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div id="tripsTable"></div>
            </div>

            <div id="claims" class="tab-content">
                <div class="action-bar">
                    <h2>Insurance Claims</h2>
                    <div>
                        <button class="btn btn-refresh" onclick="loadClaims()">üîÑ</button>
                        <button class="btn btn-primary" onclick="toggleForm('claimForm')">‚ûï File Claim</button>
                    </div>
                </div>
                <div id="claimForm" class="form-container">
                    <h3>File New Claim</h3>
                    <form onsubmit="createClaim(event)">
                        <div class="form-grid">
                            <div class="form-group"><label>Claim # *</label><input type="text" id="claimNumber" required placeholder="CLM-2025-001"></div>
                            <div class="form-group"><label>Patient ID</label><input type="text" id="claimPatientId"></div>
                            <div class="form-group"><label>Trip ID</label><input type="text" id="claimTripId"></div>
                            <div class="form-group"><label>Insurance Co.</label><input type="text" id="claimInsurance"></div>
                            <div class="form-group"><label>Amount ($)</label><input type="number" id="claimAmount" step="0.01"></div>
                            <div class="form-group"><label>Service Date</label><input type="date" id="claimServiceDate"></div>
                            <div class="form-group" style="grid-column: 1/-1;"><label>Description</label><textarea id="claimDescription"></textarea></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">File Claim</button>
                            <button type="button" class="btn" onclick="toggleForm('claimForm')">Cancel</button>
                        </div>
                    </form>
                </div>
                <div id="claimsTable"></div>
            </div>
        </div>
    </div>
<script>
        const API_BASE = 'http://127.0.0.1:5001';
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardStats();
            loadPatients();
        });
        async function loadDashboardStats() {
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/dashboard/full`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('totalPatients').textContent = data.dashboard.total_patients;
                    document.getElementById('totalDrivers').textContent = data.dashboard.total_drivers;
                    document.getElementById('totalVehicles').textContent = data.dashboard.total_vehicles;
                    document.getElementById('activeTrips').textContent = data.dashboard.active_trips;
                    document.getElementById('pendingClaims').textContent = data.dashboard.pending_claims || 0;
                }
            } catch (error) { console.error('Error:', error); }
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            switch(tabName) {
                case 'patients': loadPatients(); break;
                case 'drivers': loadDrivers(); break;
                case 'vehicles': loadVehicles(); break;
                case 'trips': loadTrips(); break;
                case 'claims': loadClaims(); break;
            }
        }
        function toggleForm(formId) {
            const form = document.getElementById(formId);
            form.classList.toggle('active');
            if (!form.classList.contains('active')) form.querySelector('form').reset();
        }
async function loadPatients() {
            const container = document.getElementById('patientsTable');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/contacts`);
                const data = await response.json();
                if (data.success && data.contacts.length > 0) {
                    let html = '<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Address</th></tr></thead><tbody>';
                    data.contacts.forEach(p => {
                        html += `<tr><td><strong>${p.firstname||''} ${p.lastname||''}</strong></td><td>${p.emailaddress1||'-'}</td><td>${p.telephone1||'-'}</td><td>${p.address1_line1||'-'}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="empty-state">No patients found</div>';
                }
            } catch (error) { container.innerHTML = '<div class="empty-state">Error loading</div>'; }
        }
        async function createPatient(event) {
            event.preventDefault();
            const data = {
                first_name: document.getElementById('patientFirstName').value,
                last_name: document.getElementById('patientLastName').value,
                phone: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value,
                address: document.getElementById('patientAddress').value,
                date_of_birth: document.getElementById('patientDOB').value
            };
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/patient`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Patient created!');
                    toggleForm('patientForm');
                    loadPatients();
                    loadDashboardStats();
                } else { alert('‚ùå Error: ' + result.error); }
            } catch (error) { alert('‚ùå Error creating patient'); }
        }
        async function loadDrivers() {
            const container = document.getElementById('driversTable');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/drivers`);
                const data = await response.json();
                if (data.success && data.drivers.length > 0) {
                    let html = '<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>License</th></tr></thead><tbody>';
                    data.drivers.forEach(d => {
                        const license = d.description ? d.description.split('License: ')[1] : '-';
                        html += `<tr><td><strong>${d.firstname||''} ${d.lastname||''}</strong></td><td>${d.emailaddress1||'-'}</td><td>${d.telephone1||'-'}</td><td>${license||'-'}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else { container.innerHTML = '<div class="empty-state">No drivers found</div>'; }
            } catch (error) { container.innerHTML = '<div class="empty-state">Error loading</div>'; }
        }
        async function createDriver(event) {
            event.preventDefault();
            const data = {
                first_name: document.getElementById('driverFirstName').value,
                last_name: document.getElementById('driverLastName').value,
                phone: document.getElementById('driverPhone').value,
                email: document.getElementById('driverEmail').value,
                address: document.getElementById('driverAddress').value,
                license_number: document.getElementById('driverLicense').value
            };
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/driver`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Driver created!');
                    toggleForm('driverForm');
                    loadDrivers();
                    loadDashboardStats();
                } else { alert('‚ùå Error: ' + result.error); }
            } catch (error) { alert('‚ùå Error creating driver'); }
        }
async function loadVehicles() {
            const container = document.getElementById('vehiclesTable');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/vehicles`);
                const data = await response.json();
                if (data.success && data.vehicles.length > 0) {
                    let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Capacity</th><th>Plate</th></tr></thead><tbody>';
                    data.vehicles.forEach(v => {
                        const desc = v.description || '';
                        const plate = desc.includes('License Plate:') ? desc.split('License Plate: ')[1]?.split(',')[0] : '-';
                        html += `<tr><td><strong>${v.accountnumber||'-'}</strong></td><td>${v.name||'-'}</td><td>${v.telephone1||'-'}</td><td>${plate}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else { container.innerHTML = '<div class="empty-state">No vehicles found</div>'; }
            } catch (error) { container.innerHTML = '<div class="empty-state">Error loading</div>'; }
        }
        async function createVehicle(event) {
            event.preventDefault();
            const data = {
                vehicle_id: document.getElementById('vehicleId').value,
                make: document.getElementById('vehicleMake').value,
                model: document.getElementById('vehicleModel').value,
                year: parseInt(document.getElementById('vehicleYear').value),
                license_plate: document.getElementById('vehiclePlate').value,
                vin: document.getElementById('vehicleVin').value,
                capacity: document.getElementById('vehicleCapacity').value
            };
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/vehicle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Vehicle created!');
                    toggleForm('vehicleForm');
                    loadVehicles();
                    loadDashboardStats();
                } else { alert('‚ùå Error: ' + result.error); }
            } catch (error) { alert('‚ùå Error creating vehicle'); }
        }
        async function loadTrips() {
            const container = document.getElementById('tripsTable');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/trips`);
                const data = await response.json();
                if (data.success && data.trips.length > 0) {
                    let html = '<table><thead><tr><th>Subject</th><th>Time</th><th>Location</th><th>Status</th></tr></thead><tbody>';
                    data.trips.forEach(t => {
                        const statusMap = {0: '<span class="badge badge-scheduled">Scheduled</span>', 1: '<span class="badge badge-completed">Completed</span>', 2: '<span class="badge badge-cancelled">Cancelled</span>'};
                        const status = statusMap[t.statecode] || 'Unknown';
                        const time = new Date(t.scheduledstart).toLocaleString();
                        html += `<tr><td><strong>${t.subject||'Trip'}</strong></td><td>${time}</td><td>${t.location||'-'}</td><td>${status}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else { container.innerHTML = '<div class="empty-state">No trips found</div>'; }
            } catch (error) { container.innerHTML = '<div class="empty-state">Error loading</div>'; }
        }
        async function createTrip(event) {
            event.preventDefault();
            const data = {
                trip_type: document.getElementById('tripType').value,
                pickup_address: document.getElementById('tripPickupAddress').value,
                pickup_time: document.getElementById('tripPickupTime').value,
                dropoff_address: document.getElementById('tripDropoffAddress').value,
                dropoff_time: document.getElementById('tripDropoffTime').value || document.getElementById('tripPickupTime').value
            };
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/trip`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Trip scheduled!');
                    toggleForm('tripForm');
                    loadTrips();
                    loadDashboardStats();
                } else { alert('‚ùå Error: ' + result.error); }
            } catch (error) { alert('‚ùå Error scheduling trip'); }
        }
async function loadClaims() {
            const container = document.getElementById('claimsTable');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/claims`);
                const data = await response.json();
                if (data.success && data.claims.length > 0) {
                    let html = '<table><thead><tr><th>Claim #</th><th>Title</th><th>Trip ID</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
                    data.claims.forEach(c => {
                        const statusMap = {0: '<span class="badge badge-submitted">Submitted</span>', 1: '<span class="badge badge-approved">Resolved</span>', 2: '<span class="badge badge-denied">Cancelled</span>'};
                        const status = statusMap[c.statecode] || 'Unknown';
                        const date = new Date(c.createdon).toLocaleDateString();
                        const actions = c.statecode === 0 ? `<button class="btn btn-approve" onclick="updateClaimStatus('${c.incidentid}','approved')">‚úì</button> <button class="btn btn-deny" onclick="updateClaimStatus('${c.incidentid}','denied')">‚úó</button>` : '';
                        html += `<tr><td><strong>${c.casenumber||'-'}</strong></td><td>${c.title||'Claim'}</td><td>${c.ticketnumber||'-'}</td><td>${status}</td><td>${date}</td><td>${actions}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else { container.innerHTML = '<div class="empty-state">No claims found. File your first claim!</div>'; }
            } catch (error) { container.innerHTML = '<div class="empty-state">Error loading</div>'; }
        }
        async function createClaim(event) {
            event.preventDefault();
            const data = {
                claim_number: document.getElementById('claimNumber').value,
                patient_id: document.getElementById('claimPatientId').value,
                trip_id: document.getElementById('claimTripId').value,
                insurance_company: document.getElementById('claimInsurance').value,
                claim_amount: document.getElementById('claimAmount').value,
                date_of_service: document.getElementById('claimServiceDate').value,
                description: document.getElementById('claimDescription').value
            };
            try {
                const response = await fetch(`${API_BASE}/api/dynamics/claim`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Claim filed!');
                    toggleForm('claimForm');
                    loadClaims();
                    loadDashboardStats();
                } else { alert('‚ùå Error: ' + result.error); }
            } catch (error) { alert('‚ùå Error filing claim'); }
        }
        async function updateClaimStatus(claimId, status) {
            if (!confirm(`Are you sure you want to ${status} this claim?`)) return;
            try {
                await fetch(`${API_BASE}/api/dynamics/claim/${claimId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });
                alert(`‚úÖ Claim ${status}!`);
                loadClaims();
                loadDashboardStats();
            } catch (error) { alert('‚ùå Error updating claim'); }
        }
    </script>
</body>
</html>
